<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DAB - Banque Universelle</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        /* Variables CSS pour les couleurs et thèmes */
        :root {
            --primary-color: #2196F3;
            --primary-dark: #1976D2;
            --secondary-color: #FFF;
            --background-color: #F5F5F5;
            --text-color: #333;
            --text-light: #666;
            --border-color: #DDD;
            --success-color: #4CAF50;
            --error-color: #F44336;
            --warning-color: #FF9800;
            --shadow: 0 2px 10px rgba(0,0,0,0.1);
            --border-radius: 8px;
            --transition: all 0.3s ease;
        }

        [data-theme="dark"] {
            --secondary-color: #2D2D2D;
            --background-color: #1A1A1A;
            --text-color: #FFF;
            --text-light: #BBB;
            --border-color: #444;
            --shadow: 0 2px 10px rgba(0,0,0,0.3);
        }

        /* Reset et styles de base */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Roboto', sans-serif;
            background-color: var(--background-color);
            color: var(--text-color);
            line-height: 1.6;
            min-height: 100vh;
            transition: var(--transition);
        }

        /* Header */
        .header {
            background: var(--primary-color);
            color: white;
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: var(--shadow);
        }

        .logo {
            font-size: 1.5rem;
            font-weight: 700;
        }

        .theme-toggle {
            background: transparent;
            border: 2px solid white;
            color: white;
            padding: 0.5rem 1rem;
            border-radius: var(--border-radius);
            cursor: pointer;
            transition: var(--transition);
        }

        .theme-toggle:hover {
            background: white;
            color: var(--primary-color);
        }

        /* Container principal */
        .container {
            max-width: 800px;
            margin: 2rem auto;
            padding: 0 1rem;
        }

        /* Écrans */
        .screen {
            background: var(--secondary-color);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            padding: 2rem;
            margin-bottom: 2rem;
            opacity: 0;
            transform: translateY(20px);
            transition: var(--transition);
            display: none;
        }

        .screen.active {
            display: block;
            opacity: 1;
            transform: translateY(0);
            animation: fadeInUp 0.4s ease;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Titre des écrans */
        .screen-title {
            font-size: 1.8rem;
            font-weight: 500;
            margin-bottom: 2rem;
            text-align: center;
            color: var(--primary-color);
        }

        /* Formulaires */
        .form-group {
            margin-bottom: 1.5rem;
        }

        label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: var(--text-light);
        }

        input[type="text"],
        input[type="password"],
        input[type="number"] {
            width: 100%;
            padding: 1rem;
            border: 2px solid var(--border-color);
            border-radius: var(--border-radius);
            font-size: 1rem;
            background: var(--secondary-color);
            color: var(--text-color);
            transition: var(--transition);
        }

        input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(33, 150, 243, 0.1);
        }

        /* Boutons */
        .btn {
            padding: 1rem 2rem;
            border: none;
            border-radius: var(--border-radius);
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: var(--transition);
            text-decoration: none;
            display: inline-block;
            text-align: center;
            min-width: 120px;
        }

        .btn-primary {
            background: var(--primary-color);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(33, 150, 243, 0.3);
        }

        .btn-secondary {
            background: transparent;
            color: var(--text-color);
            border: 2px solid var(--border-color);
        }

        .btn-secondary:hover {
            border-color: var(--primary-color);
            color: var(--primary-color);
        }

        .btn-success {
            background: var(--success-color);
            color: white;
        }

        .btn-error {
            background: var(--error-color);
            color: white;
        }

        .btn-large {
            padding: 1.5rem 3rem;
            font-size: 1.1rem;
            width: 100%;
            margin-bottom: 1rem;
        }

        /* Grille de boutons pour les montants */
        .amount-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
            margin: 2rem 0;
        }

        .amount-btn {
            padding: 1.5rem;
            background: var(--secondary-color);
            border: 2px solid var(--border-color);
            border-radius: var(--border-radius);
            font-size: 1.1rem;
            font-weight: 500;
            cursor: pointer;
            transition: var(--transition);
        }

        .amount-btn:hover,
        .amount-btn.selected {
            border-color: var(--primary-color);
            background: var(--primary-color);
            color: white;
            transform: translateY(-2px);
        }

        /* Messages */
        .message {
            padding: 1rem;
            border-radius: var(--border-radius);
            margin-bottom: 1rem;
            font-weight: 500;
        }

        .message.error {
            background: rgba(244, 67, 54, 0.1);
            color: var(--error-color);
            border: 1px solid var(--error-color);
        }

        .message.success {
            background: rgba(76, 175, 80, 0.1);
            color: var(--success-color);
            border: 1px solid var(--success-color);
        }

        .message.warning {
            background: rgba(255, 152, 0, 0.1);
            color: var(--warning-color);
            border: 1px solid var(--warning-color);
        }

        /* Solde display */
        .balance-display {
            background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
            color: white;
            padding: 2rem;
            border-radius: var(--border-radius);
            text-align: center;
            margin: 2rem 0;
        }

        .balance-amount {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }

        .balance-label {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        /* Menu principal */
        .menu-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
            margin: 2rem 0;
        }

        .menu-item {
            background: var(--secondary-color);
            border: 2px solid var(--border-color);
            border-radius: var(--border-radius);
            padding: 2rem;
            text-align: center;
            cursor: pointer;
            transition: var(--transition);
            text-decoration: none;
            color: var(--text-color);
        }

        .menu-item:hover {
            border-color: var(--primary-color);
            transform: translateY(-5px);
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
        }

        .menu-icon {
            font-size: 2.5rem;
            margin-bottom: 1rem;
        }

        .menu-title {
            font-size: 1.2rem;
            font-weight: 500;
        }

        /* Footer */
        .footer {
            background: var(--secondary-color);
            padding: 2rem;
            text-align: center;
            border-top: 1px solid var(--border-color);
            margin-top: 2rem;
            color: var(--text-light);
        }

        /* Modal pour confirmations */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
        }

        .modal-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: var(--secondary-color);
            padding: 2rem;
            border-radius: var(--border-radius);
            max-width: 500px;
            width: 90%;
            box-shadow: var(--shadow);
        }

        .modal-header {
            font-size: 1.3rem;
            font-weight: 500;
            margin-bottom: 1rem;
            color: var(--primary-color);
        }

        .modal-actions {
            display: flex;
            gap: 1rem;
            justify-content: flex-end;
            margin-top: 2rem;
        }

        /* Toast notifications */
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 1rem 1.5rem;
            background: var(--success-color);
            color: white;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            z-index: 1001;
            opacity: 0;
            transform: translateX(100%);
            transition: var(--transition);
        }

        .toast.show {
            opacity: 1;
            transform: translateX(0);
        }

        .toast.error {
            background: var(--error-color);
        }

        /* Loader */
        .loader {
            display: none;
            width: 40px;
            height: 40px;
            border: 4px solid var(--border-color);
            border-top: 4px solid var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 2rem auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Responsive */
        @media (max-width: 768px) {
            .container {
                margin: 1rem auto;
                padding: 0 0.5rem;
            }

            .screen {
                padding: 1.5rem;
            }

            .header {
                padding: 1rem;
            }

            .amount-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .menu-grid {
                grid-template-columns: 1fr;
            }

            .balance-amount {
                font-size: 2rem;
            }
        }

        /* États pour la gestion de carte avalée */
        .card-swallowed {
            background: var(--error-color);
            color: white;
        }

        .operator-interface {
            background: var(--warning-color);
            color: white;
            padding: 1rem;
            border-radius: var(--border-radius);
            margin-top: 1rem;
        }

        /* Animations d'entrée et sortie */
        .slide-out {
            animation: slideOut 0.3s ease forwards;
        }

        @keyframes slideOut {
            to {
                opacity: 0;
                transform: translateX(-100%);
            }
        }

        .slide-in {
            animation: slideIn 0.3s ease forwards;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(100%);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="logo">🏦 Banque Universelle</div>
        <button class="theme-toggle" onclick="toggleTheme()">🌙 Mode sombre</button>
    </header>

    <!-- Container principal -->
    <div class="container">
        <!-- Toast notifications -->
        <div id="toast" class="toast"></div>

        <!-- Écran de connexion -->
        <div id="login-screen" class="screen active">
            <h2 class="screen-title">Connexion sécurisée</h2>
            <div id="login-message"></div>
            
            <form id="login-form">
                <div class="form-group">
                    <label for="card-number">Numéro de carte</label>
                    <input type="text" id="card-number" placeholder="1234 5678 9012 3456" maxlength="19" required>
                </div>
                
                <div class="form-group">
                    <label for="pin">Code PIN</label>
                    <input type="password" id="pin" placeholder="••••" maxlength="4" required>
                </div>
                
                <button type="submit" class="btn btn-primary btn-large">Se connecter</button>
            </form>
        </div>

        <!-- Menu principal -->
        <div id="main-menu" class="screen">
            <h2 class="screen-title" id="welcome-message">Bienvenue</h2>
            
            <div class="menu-grid">
                <div class="menu-item" onclick="showScreen('balance-screen')">
                    <div class="menu-icon">💰</div>
                    <div class="menu-title">Consulter le solde</div>
                </div>
                
                <div class="menu-item" onclick="showScreen('withdraw-screen')">
                    <div class="menu-icon">💸</div>
                    <div class="menu-title">Retirer de l'argent</div>
                </div>
                
                <div class="menu-item" onclick="showScreen('deposit-screen')">
                    <div class="menu-icon">💵</div>
                    <div class="menu-title">Déposer de l'argent</div>
                </div>
                
                <div class="menu-item" onclick="logout()">
                    <div class="menu-icon">🚪</div>
                    <div class="menu-title">Déconnexion</div>
                </div>
            </div>
        </div>

        <!-- Consultation solde -->
        <div id="balance-screen" class="screen">
            <h2 class="screen-title">Votre solde</h2>
            
            <div class="balance-display">
                <div class="balance-amount" id="balance-amount">0,00 €</div>
                <div class="balance-label">Solde disponible</div>
            </div>
            
            <button class="btn btn-secondary btn-large" onclick="showScreen('main-menu')">Retour au menu</button>
        </div>

        <!-- Retrait d'argent -->
        <div id="withdraw-screen" class="screen">
            <h2 class="screen-title">Retrait d'argent</h2>
            <div id="withdraw-message"></div>
            
            <div class="amount-grid">
                <button class="amount-btn" onclick="selectAmount(20)">20 €</button>
                <button class="amount-btn" onclick="selectAmount(50)">50 €</button>
                <button class="amount-btn" onclick="selectAmount(100)">100 €</button>
                <button class="amount-btn" onclick="selectAmount(200)">200 €</button>
            </div>
            
            <div class="form-group">
                <label for="custom-amount">Montant personnalisé</label>
                <input type="number" id="custom-amount" placeholder="Entrez le montant" min="10" max="500" step="10">
            </div>
            
            <div style="display: flex; gap: 1rem;">
                <button class="btn btn-primary" onclick="confirmWithdraw()">Confirmer le retrait</button>
                <button class="btn btn-secondary" onclick="showScreen('main-menu')">Annuler</button>
            </div>
        </div>

        <!-- Dépôt d'argent -->
        <div id="deposit-screen" class="screen">
            <h2 class="screen-title">Dépôt d'argent</h2>
            <div id="deposit-message"></div>
            
            <div class="form-group">
                <label>Type de dépôt</label>
                <div style="display: flex; gap: 1rem; margin-top: 0.5rem;">
                    <button class="btn btn-secondary" id="cash-deposit" onclick="selectDepositType('cash')">Numéraire</button>
                    <button class="btn btn-secondary" id="check-deposit" onclick="selectDepositType('check')">Chèque</button>
                </div>
            </div>
            
            <div class="form-group">
                <label for="deposit-amount">Montant</label>
                <input type="number" id="deposit-amount" placeholder="Entrez le montant" min="1" step="0.01">
            </div>
            
            <div style="display: flex; gap: 1rem;">
                <button class="btn btn-primary" onclick="confirmDeposit()">Confirmer le dépôt</button>
                <button class="btn btn-secondary" onclick="showScreen('main-menu')">Annuler</button>
            </div>
        </div>

        <!-- Carte avalée -->
        <div id="card-swallowed-screen" class="screen card-swallowed">
            <h2 class="screen-title">⚠️ Carte avalée</h2>
            
            <div class="message error">
                <p>Votre carte a été avalée par le distributeur suite à plusieurs tentatives incorrectes.</p>
                <p>Veuillez contacter votre banque ou utilisez l'interface opérateur ci-dessous.</p>
            </div>
            
            <div class="operator-interface">
                <h3>Interface opérateur</h3>
                <p>Code opérateur requis pour libérer la carte</p>
                <input type="password" id="operator-code" placeholder="Code opérateur" style="margin: 1rem 0;">
                <button class="btn btn-secondary" onclick="releaseCard()">Libérer la carte</button>
            </div>
        </div>

        <!-- Loader -->
        <div id="loader" class="loader"></div>
    </div>

    <!-- Modal de confirmation -->
    <div id="confirmation-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header" id="modal-title">Confirmation</div>
            <div id="modal-message">Êtes-vous sûr de vouloir continuer ?</div>
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="closeModal()">Annuler</button>
                <button class="btn btn-primary" id="modal-confirm" onclick="confirmAction()">Confirmer</button>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="footer">
        <p>© 2025 Banque Universelle - Service client : 0800 123 456</p>
        <p>En cas d'urgence, contactez immédiatement votre banque</p>
    </footer>

    <script>
        // Variables globales pour simulation des données
        let currentUser = null;
        let userBalance = 1250.50;
        let selectedAmount = 0;
        let depositType = '';
        let failedLoginAttempts = 0;
        const MAX_LOGIN_ATTEMPTS = 3;
        let sessionToken = null;

        // Données utilisateur fictives
        const users = {
            '1234567890123456': { pin: '1234', name: 'M. Dupont', balance: 1250.50 },
            '9876543210987654': { pin: '5678', name: 'Mme Martin', balance: 2500.75 }
        };

        // Initialisation
        document.addEventListener('DOMContentLoaded', function() {
            // Format automatique du numéro de carte
            document.getElementById('card-number').addEventListener('input', formatCardNumber);
            
            // Gestion du custom amount
            document.getElementById('custom-amount').addEventListener('input', function() {
                clearAmountSelection();
                selectedAmount = parseFloat(this.value) || 0;
            });

            // Navigation au clavier
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    closeModal();
                }
            });
        });

        // Gestion du thème
        function toggleTheme() {
            const body = document.body;
            const themeToggle = document.querySelector('.theme-toggle');
            
            if (body.getAttribute('data-theme') === 'dark') {
                body.removeAttribute('data-theme');
                themeToggle.innerHTML = '🌙 Mode sombre';
            } else {
                body.setAttribute('data-theme', 'dark');
                themeToggle.innerHTML = '☀️ Mode clair';
            }
        }

        // Formatage automatique du numéro de carte
        function formatCardNumber(e) {
            let value = e.target.value.replace(/\s/g, '').replace(/[^0-9]/gi, '');
            let formattedValue = value.match(/.{1,4}/g)?.join(' ') || value;
            if (formattedValue !== e.target.value) {
                e.target.value = formattedValue;
            }
        }

        // Affichage des écrans
        function showScreen(screenId) {
            // Masquer tous les écrans
            document.querySelectorAll('.screen').forEach(screen => {
                screen.classList.remove('active');
            });
            
            // Afficher l'écran demandé
            setTimeout(() => {
                document.getElementById(screenId).classList.add('active');
            }, 150);
        }

        // Gestion de la connexion
        document.getElementById('login-form').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const cardNumber = document.getElementById('card-number').value.replace(/\s/g, '');
            const pin = document.getElementById('pin').value;
            
            // Validation locale
            if (!validateCardNumber(cardNumber)) {
                showMessage('login-message', 'Numéro de carte invalide', 'error');
                return;
            }
            
            if (!validatePin(pin)) {
                showMessage('login-message', 'PIN doit contenir 4 chiffres', 'error');
                return;
            }
            
            // Simulation d'authentification
            showLoader();
            
            setTimeout(() => {
                hideLoader();
                
                if (users[cardNumber] && users[cardNumber].pin === pin) {
                    // Connexion réussie
                    currentUser = users[cardNumber];
                    userBalance = currentUser.balance;
                    sessionToken = generateSessionToken();
                    failedLoginAttempts = 0;
                    
                    document.getElementById('welcome-message').textContent = `Bonjour, ${currentUser.name}`;
                    document.getElementById('balance-amount').textContent = formatCurrency(userBalance);
                    
                    showToast('Connexion réussie !', 'success');
                    showScreen('main-menu');
                } else {
                    // Échec de connexion
                    failedLoginAttempts++;
                    
                    if (failedLoginAttempts >= MAX_LOGIN_ATTEMPTS) {
                        showMessage('login-message', 'Carte avalée suite à trop de tentatives incorrectes', 'error');
                        setTimeout(() => showScreen('card-swallowed-screen'), 2000);
                    } else {
                        showMessage('login-message', `Identifiants incorrects. Tentatives restantes: ${MAX_LOGIN_ATTEMPTS - failedLoginAttempts}`, 'error');
                    }
                }
            }, 1500);
        });

        // Validation du numéro de carte
        function validateCardNumber(cardNumber) {
            return /^\d{16}$/.test(cardNumber);
        }

        // Validation du PIN
        function validatePin(pin) {
            return /^\d{4}$/.test(pin);
        }

        // Génération d'un token de session
        function generateSessionToken() {
            return Math.random().toString(36).substr(2, 9);
        }

        // Sélection du montant pour retrait
        function selectAmount(amount) {
            clearAmountSelection();
            selectedAmount = amount;
            event.target.classList.add('selected');
            document.getElementById('custom-amount').value = '';
        }

        function clearAmountSelection() {
            document.querySelectorAll('.amount-btn').forEach(btn => {
                btn.classList.remove('selected');
            });
        }

        // Confirmation de retrait
        function confirmWithdraw() {
            if (selectedAmount <= 0) {
                showMessage('withdraw-message', 'Veuillez sélectionner un montant', 'error');
                return;
            }
            
            if (selectedAmount > userBalance) {
                showMessage('withdraw-message', 'Solde insuffisant', 'error');
                return;
            }
            
            if (selectedAmount > 500) {
                showMessage('withdraw-message', 'Montant maximum autorisé: 500€', 'error');
                return;
            }
            
            showModal(
                'Confirmation de retrait',
                `Confirmer le retrait de ${formatCurrency(selectedAmount)} ?`,
                processWithdraw
            );
        }

        // Traitement du retrait
        function processWithdraw() {
            closeModal();
            showLoader();
            
            setTimeout(() => {
                hideLoader();
                userBalance -= selectedAmount;
                document.getElementById('balance-amount').textContent = formatCurrency(userBalance);
                
                showToast(`Retrait de ${formatCurrency(selectedAmount)} effectué avec succès`, 'success');
                selectedAmount = 0;
                clearAmountSelection();
                document.getElementById('custom-amount').value = '';
                showMessage('withdraw-message', '', '');
                showScreen('main-menu');
            }, 2000);
        }

        // Sélection du type de dépôt
        function selectDepositType(type) {
            depositType = type;
            
            // Réinitialiser les boutons
            document.getElementById('cash-deposit').className = 'btn btn-secondary';
            document.getElementById('check-deposit').className = 'btn btn-secondary';
            
            // Sélectionner le type
            if (type === 'cash') {
                document.getElementById('cash-deposit').className = 'btn btn-primary';
            } else {
                document.getElementById('check-deposit').className = 'btn btn-primary';
            }
        }

        // Confirmation de dépôt
        function confirmDeposit() {
            const amount = parseFloat(document.getElementById('deposit-amount').value);
            
            if (!depositType) {
                showMessage('deposit-message', 'Veuillez sélectionner le type de dépôt', 'error');
                return;
            }
            
            if (!amount || amount <= 0) {
                showMessage('deposit-message', 'Veuillez entrer un montant valide', 'error');
                return;
            }
            
            showModal(
                'Confirmation de dépôt',
                `Confirmer le dépôt de ${formatCurrency(amount)} (${depositType === 'cash' ? 'numéraire' : 'chèque'}) ?`,
                () => processDeposit(amount)
            );
        }

        // Traitement du dépôt
        function processDeposit(amount) {
            closeModal();
            showLoader();
            
            setTimeout(() => {
                hideLoader();
                userBalance += amount;
                document.getElementById('balance-amount').textContent = formatCurrency(userBalance);
                
                showToast(`Dépôt de ${formatCurrency(amount)} effectué avec succès`, 'success');
                
                // Réinitialiser le formulaire
                document.getElementById('deposit-amount').value = '';
                depositType = '';
                document.getElementById('cash-deposit').className = 'btn btn-secondary';
                document.getElementById('check-deposit').className = 'btn btn-secondary';
                showMessage('deposit-message', '', '');
                
                showScreen('main-menu');
            }, 2000);
        }

        // Libération de la carte (interface opérateur)
        function releaseCard() {
            const operatorCode = document.getElementById('operator-code').value;
            
            if (operatorCode === 'ADMIN123') {
                showLoader();
                setTimeout(() => {
                    hideLoader();
                    showToast('Carte libérée avec succès', 'success');
                    failedLoginAttempts = 0;
                    document.getElementById('operator-code').value = '';
                    showScreen('login-screen');
                }, 1500);
            } else {
                showToast('Code opérateur incorrect', 'error');
            }
        }

        // Déconnexion
        function logout() {
            showModal(
                'Déconnexion',
                'Êtes-vous sûr de vouloir vous déconnecter ?',
                () => {
                    closeModal();
                    currentUser = null;
                    sessionToken = null;
                    
                    // Réinitialiser les formulaires
                    document.getElementById('card-number').value = '';
                    document.getElementById('pin').value = '';
                    showMessage('login-message', '', '');
                    
                    showToast('Déconnexion réussie', 'success');
                    showScreen('login-screen');
                }
            );
        }

        // Gestion des messages
        function showMessage(containerId, message, type) {
            const container = document.getElementById(containerId);
            if (message) {
                container.innerHTML = `<div class="message ${type}">${message}</div>`;
            } else {
                container.innerHTML = '';
            }
        }

        // Gestion des toasts
        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = `toast ${type} show`;
            
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }

        // Gestion du loader
        function showLoader() {
            document.getElementById('loader').style.display = 'block';
        }

        function hideLoader() {
            document.getElementById('loader').style.display = 'none';
        }

        // Gestion des modales
        function showModal(title, message, confirmCallback) {
            document.getElementById('modal-title').textContent = title;
            document.getElementById('modal-message').textContent = message;
            document.getElementById('confirmation-modal').style.display = 'block';
            
            // Stocker la callback pour la confirmation
            window.modalConfirmCallback = confirmCallback;
        }

        function closeModal() {
            document.getElementById('confirmation-modal').style.display = 'none';
            window.modalConfirmCallback = null;
        }

        function confirmAction() {
            if (window.modalConfirmCallback) {
                window.modalConfirmCallback();
            }
        }

        // Formatage des montants
        function formatCurrency(amount) {
            return new Intl.NumberFormat('fr-FR', {
                style: 'currency',
                currency: 'EUR'
            }).format(amount);
        }

        // Gestion des erreurs de session
        function checkSession() {
            if (!sessionToken && currentUser) {
                showToast('Session expirée, veuillez vous reconnecter', 'error');
                logout();
            }
        }

        // Vérification périodique de la session (simulation)
        setInterval(checkSession, 300000); // 5 minutes

        // Gestion des événements clavier pour l'accessibilité
        document.addEventListener('keydown', function(e) {
            // Navigation avec les flèches dans les menus
            if (e.key === 'ArrowDown' || e.key === 'ArrowUp') {
                const activeScreen = document.querySelector('.screen.active');
                if (activeScreen) {
                    const focusableElements = activeScreen.querySelectorAll('button, input, .menu-item');
                    const currentIndex = Array.from(focusableElements).indexOf(document.activeElement);
                    
                    let nextIndex;
                    if (e.key === 'ArrowDown') {
                        nextIndex = currentIndex < focusableElements.length - 1 ? currentIndex + 1 : 0;
                    } else {
                        nextIndex = currentIndex > 0 ? currentIndex - 1 : focusableElements.length - 1;
                    }
                    
                    if (focusableElements[nextIndex]) {
                        focusableElements[nextIndex].focus();
                        e.preventDefault();
                    }
                }
            }
            
            // Retour avec Échap
            if (e.key === 'Escape') {
                const activeScreen = document.querySelector('.screen.active');
                if (activeScreen && activeScreen.id !== 'login-screen' && activeScreen.id !== 'main-menu') {
                    if (activeScreen.id === 'card-swallowed-screen') {
                        return; // Ne pas permettre de sortir de l'écran carte avalée
                    }
                    showScreen('main-menu');
                }
            }
        });

        // Ajout d'attributs d'accessibilité
        function initAccessibility() {
            // Ajouter des labels ARIA
            document.querySelectorAll('.menu-item').forEach((item, index) => {
                item.setAttribute('role', 'button');
                item.setAttribute('tabindex', '0');
                item.setAttribute('aria-label', item.querySelector('.menu-title').textContent);
            });

            // Gestion des clics sur les éléments avec le clavier
            document.querySelectorAll('.menu-item, .amount-btn').forEach(element => {
                element.addEventListener('keydown', function(e) {
                    if (e.key === 'Enter' || e.key === ' ') {
                        e.preventDefault();
                        element.click();
                    }
                });
            });
        }

        // Initialisation de l'accessibilité au chargement
        document.addEventListener('DOMContentLoaded', initAccessibility);

        // Fonction de sauvegarde des données (simulation localStorage sans l'utiliser réellement)
        function saveUserData() {
            // En production, ceci enverrait les données au serveur
            console.log('Données utilisateur sauvegardées:', {
                user: currentUser?.name,
                balance: userBalance,
                timestamp: new Date().toISOString()
            });
        }

        // Auto-sauvegarde périodique
        setInterval(saveUserData, 60000); // Chaque minute

        // Gestion des erreurs réseau (simulation)
        function handleNetworkError() {
            showToast('Erreur de connexion. Veuillez réessayer.', 'error');
            hideLoader();
        }

        // Simulation d'une perte de connexion occasionnelle
        function simulateRandomNetworkError() {
            if (Math.random() < 0.05) { // 5% de chance d'erreur
                return true;
            }
            return false;
        }

        // Protection contre les attaques de force brute (simulation)
        function checkBruteForce() {
            if (failedLoginAttempts >= MAX_LOGIN_ATTEMPTS) {
                setTimeout(() => {
                    showScreen('card-swallowed-screen');
                }, 1000);
                return true;
            }
            return false;
        }

        // Fonction utilitaire pour le debugging (à retirer en production)
        function debugInfo() {
            console.log('État de l\'application:', {
                currentUser: currentUser?.name,
                balance: userBalance,
                sessionToken: sessionToken,
                failedAttempts: failedLoginAttempts,
                activeScreen: document.querySelector('.screen.active')?.id
            });
        }

        // Raccourci clavier pour le debug (Ctrl + D)
        document.addEventListener('keydown', function(e) {
            if (e.ctrlKey && e.key === 'd') {
                e.preventDefault();
                debugInfo();
            }
        });

        // Gestion du focus pour l'accessibilité
        function manageFocus() {
            const activeScreen = document.querySelector('.screen.active');
            if (activeScreen) {
                const firstFocusable = activeScreen.querySelector('input, button, .menu-item');
                if (firstFocusable) {
                    firstFocusable.focus();
                }
            }
        }

        // Observer pour gérer le focus lors des changements d'écran
        const screenObserver = new MutationObserver(function(mutations) {
            mutations.forEach(function(mutation) {
                if (mutation.type === 'attributes' && mutation.attributeName === 'class') {
                    if (mutation.target.classList.contains('active')) {
                        setTimeout(manageFocus, 100);
                    }
                }
            });
        });

        // Observer tous les écrans
        document.querySelectorAll('.screen').forEach(screen => {
            screenObserver.observe(screen, { attributes: true });
        });

        // Fonction de nettoyage au déchargement de la page
        window.addEventListener('beforeunload', function() {
            if (currentUser) {
                saveUserData();
            }
        });

        // Message de maintenance (simulation)
        function showMaintenanceMessage() {
            if (Math.random() < 0.01) { // 1% de chance
                showToast('Maintenance programmée ce soir de 2h à 4h', 'warning');
            }
        }

        // Vérification de maintenance au chargement
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(showMaintenanceMessage, 5000);
        });
    </script>
</body>
</html>
